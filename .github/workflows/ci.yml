name: CI - Build and Test

# Trigger on pull requests and manual dispatch
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  workflow_dispatch:
    inputs:
      run_all_tests:
        description: 'Run all test scenarios (ignore other inputs)'
        required: false
        default: true
        type: boolean
      test_url:
        description: 'URL to test screenshot functionality (single test mode)'
        required: false
        default: 'https://github.com/jantielens/ha-screenshotter/'
      resolution_width:
        description: 'Screenshot width (single test mode)'
        required: false
        default: '1366'
      resolution_height:
        description: 'Screenshot height (single test mode)'
        required: false
        default: '768'
      rotation:
        description: 'Rotation degrees (single test mode)'
        required: false
        default: '90'
      grayscale:
        description: 'Enable grayscale (single test mode)'
        required: false
        default: true
        type: boolean
      bit_depth:
        description: 'Bit depth (single test mode)'
        required: false
        default: '4'
      screenshots_subfolder:
        description: 'Subfolder name inside /media where screenshots are written'
        required: false
        default: 'ha-screenshotter'

jobs:
  # Single test job for manual dispatch when run_all_tests is false
  single-test:
    if: ${{ github.event_name == 'workflow_dispatch' && !fromJson(github.event.inputs.run_all_tests || 'true') }}
    runs-on: ubuntu-latest
    env:
      SCREENSHOT_SUBFOLDER: ${{ github.event.inputs.screenshots_subfolder || 'ha-screenshotter' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up test directories
        run: |
            mkdir -p test-data test-share/$SCREENSHOT_SUBFOLDER

      - name: Create test configuration
        run: |
          cat > test-data/options.json << EOF
          {
            "schedule": "*/1 * * * *",
            "urls": "[\\\"${{ github.event.inputs.test_url || 'https://github.com/jantielens/ha-screenshotter/' }}\\\"]",
            "resolution_width": ${{ github.event.inputs.resolution_width || 1366 }},
            "resolution_height": ${{ github.event.inputs.resolution_height || 768 }},
            "rotation_degrees": ${{ github.event.inputs.rotation || 90 }},
            "grayscale": ${{ github.event.inputs.grayscale || true }},
            "bit_depth": ${{ github.event.inputs.bit_depth || 4 }},
            "run_once": true
          }
          EOF
          echo "Test configuration:"
          cat test-data/options.json

      - name: Build Docker container
        run: |
          cd ha-screenshotter
          docker build -t ha-screenshotter-test .

      - name: Test container startup and screenshot
        run: |
          echo "Starting container test with run_once mode..."
          docker run --rm \
            -v "${GITHUB_WORKSPACE}/test-data:/data" \
            -v "${GITHUB_WORKSPACE}/test-share:/media" \
            ha-screenshotter-test
          echo "Container run completed"

      - name: Verify screenshot output
        run: |
          echo "Checking for generated screenshots..."
          ls -la test-share/$SCREENSHOT_SUBFOLDER/

          if [ -f "test-share/$SCREENSHOT_SUBFOLDER/0.png" ]; then
            echo "âœ… Screenshot generated successfully!"
            file test-share/$SCREENSHOT_SUBFOLDER/0.png || true
            if command -v identify &> /dev/null; then
              echo "Image details:"
              identify test-share/$SCREENSHOT_SUBFOLDER/0.png
            fi
            size=$(stat -c%s test-share/$SCREENSHOT_SUBFOLDER/0.png)
            echo "Screenshot file size: $size bytes"
            if [ "$size" -gt 1000 ]; then
              echo "âœ… Screenshot appears to be valid (size > 1KB)"
            else
              echo "âŒ Screenshot file seems too small"
              exit 1
            fi
          else
            echo "âŒ No screenshot generated"
            echo "Contents of '${SCREENSHOT_SUBFOLDER}' directory:"
            ls -la test-share/$SCREENSHOT_SUBFOLDER/
            exit 1
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: single-test-screenshots
          path: test-share/${{ env.SCREENSHOT_SUBFOLDER }}/
          retention-days: 7

  # Matrix test job for comprehensive testing
  matrix-test:
    if: ${{ github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && fromJson(github.event.inputs.run_all_tests || 'true')) }}
    runs-on: ubuntu-latest
    env:
      SCREENSHOT_SUBFOLDER: ${{ github.event.inputs.screenshots_subfolder || 'ha-screenshotter' }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # Valid parameter tests
          - name: "basic-test"
            description: "Single URL, no grayscale, full bit depth"
            urls: '[\"https://example.com\"]'
            resolution_width: 1366
            resolution_height: 768
            rotation_degrees: 0
            grayscale: false
            bit_depth: 8
            expected_result: "success"
            expected_files: 1
          
          - name: "multi-grayscale-medium"
            description: "Two URLs, grayscale, medium bit depth"
            urls: '[\"https://github.com/jantielens/ha-screenshotter\", \"https://example.com\"]'
            resolution_width: 1920
            resolution_height: 1080
            rotation_degrees: 90
            grayscale: true
            bit_depth: 4
            expected_result: "success"
            expected_files: 2
          
          - name: "multi-grayscale-minimal"
            description: "Two URLs, grayscale, minimal bit depth"
            urls: '[\"https://phet-dev.colorado.edu/html/build-an-atom/0.0.0-3/simple-text-only-test-page.html\", \"https://example.com\"]'
            resolution_width: 800
            resolution_height: 600
            rotation_degrees: 180
            grayscale: true
            bit_depth: 1
            expected_result: "success"
            expected_files: 2
          
          # Invalid parameter tests
          - name: "invalid-url"
            description: "Non-existent URL test"
            urls: '[\"https://nonexistent-test-domain-12345.com\"]'
            resolution_width: 1366
            resolution_height: 768
            rotation_degrees: 0
            grayscale: false
            bit_depth: 8
            expected_result: "failure"
            expected_files: 0
          
          - name: "malformed-urls"
            description: "Invalid JSON format for URLs"
            urls: 'invalid-json-format-not-an-array'
            resolution_width: 1366
            resolution_height: 768
            rotation_degrees: 0
            grayscale: false
            bit_depth: 8
            expected_result: "failure"
            expected_files: 0
          
          - name: "invalid-bit-depth"
            description: "Invalid bit depth value"
            urls: '[\"https://example.com\"]'
            resolution_width: 1366
            resolution_height: 768
            rotation_degrees: 0
            grayscale: true
            bit_depth: 99
            expected_result: "success"  # Should fallback to default
            expected_files: 1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install image analysis tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick file

      - name: Set up test directories
        run: |
          mkdir -p test-data-${{ matrix.name }} test-share-${{ matrix.name }}/$SCREENSHOT_SUBFOLDER

      - name: Create test configuration
        run: |
          cat > test-data-${{ matrix.name }}/options.json << EOF
          {
            "schedule": "*/1 * * * *",
            "urls": "${{ matrix.urls }}",
            "resolution_width": ${{ matrix.resolution_width }},
            "resolution_height": ${{ matrix.resolution_height }},
            "rotation_degrees": ${{ matrix.rotation_degrees }},
            "grayscale": ${{ matrix.grayscale }},
            "bit_depth": ${{ matrix.bit_depth }},
            "run_once": true
          }
          EOF
          echo "=== Test Configuration for ${{ matrix.name }} ==="
          echo "${{ matrix.description }}"
          echo "Expected result: ${{ matrix.expected_result }}"
          echo "Expected files: ${{ matrix.expected_files }}"
          cat test-data-${{ matrix.name }}/options.json

      - name: Build Docker container
        run: |
          cd ha-screenshotter
          docker build -t ha-screenshotter-test-${{ matrix.name }} .

      - name: Run container test
        id: container_test
        continue-on-error: true
        run: |
          echo "Starting container test: ${{ matrix.name }}"
          echo "Description: ${{ matrix.description }}"
          
          # Capture container output and exit code
          set +e
          docker run --rm \
            -v "${GITHUB_WORKSPACE}/test-data-${{ matrix.name }}:/data" \
            -v "${GITHUB_WORKSPACE}/test-share-${{ matrix.name }}:/media" \
            ha-screenshotter-test-${{ matrix.name }} 2>&1 | tee container-output-${{ matrix.name }}.log
          CONTAINER_EXIT_CODE=$?
          set -e
          
          echo "Container exit code: $CONTAINER_EXIT_CODE"
          echo "container_exit_code=$CONTAINER_EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Always continue to validation step
          exit 0

      - name: Validate test results
        id: validate
        run: |
          echo "=== Validating results for ${{ matrix.name }} ==="
          
          TEST_PASSED=true
          VALIDATION_MESSAGES=""
          
          # Check if screenshots directory exists
          SCREENSHOT_DIR="test-share-${{ matrix.name }}/$SCREENSHOT_SUBFOLDER"
          if [ ! -d "$SCREENSHOT_DIR" ]; then
            echo "âŒ Screenshot directory not found: $SCREENSHOT_DIR"
            VALIDATION_MESSAGES="${VALIDATION_MESSAGES}- Screenshot directory missing\n"
            TEST_PASSED=false
          else
            echo "âœ… Screenshot directory exists: $SCREENSHOT_DIR"
            ls -la "$SCREENSHOT_DIR"
            
            # Count generated files
            ACTUAL_FILES=$(find "$SCREENSHOT_DIR" -name "*.png" | wc -l)
            echo "Files found: $ACTUAL_FILES, Expected: ${{ matrix.expected_files }}"
            
            if [ "${{ matrix.expected_result }}" = "success" ]; then
              if [ "$ACTUAL_FILES" -eq "${{ matrix.expected_files }}" ]; then
                echo "âœ… Correct number of screenshots generated"
                VALIDATION_MESSAGES="${VALIDATION_MESSAGES}- Generated $ACTUAL_FILES screenshots âœ…\n"
                
                # Validate each screenshot
                for i in $(seq 0 $((ACTUAL_FILES - 1))); do
                  SCREENSHOT_FILE="$SCREENSHOT_DIR/$i.png"
                  if [ -f "$SCREENSHOT_FILE" ]; then
                    # Check file size
                    SIZE=$(stat -c%s "$SCREENSHOT_FILE")
                    echo "Screenshot $i size: $SIZE bytes"
                    
                    if [ "$SIZE" -lt 1000 ]; then
                      echo "âŒ Screenshot $i too small: $SIZE bytes"
                      VALIDATION_MESSAGES="${VALIDATION_MESSAGES}- Screenshot $i too small ($SIZE bytes) âŒ\n"
                      TEST_PASSED=false
                    else
                      echo "âœ… Screenshot $i size acceptable: $SIZE bytes"
                      VALIDATION_MESSAGES="${VALIDATION_MESSAGES}- Screenshot $i: $SIZE bytes âœ…\n"
                    fi
                    
                    # Check image properties using ImageMagick
                    if command -v identify &> /dev/null; then
                      IMAGE_INFO=$(identify "$SCREENSHOT_FILE" 2>/dev/null || echo "Failed to analyze image")
                      echo "Image info for $i: $IMAGE_INFO"
                      
                      # Extract dimensions and check against expected resolution
                      if [[ "$IMAGE_INFO" =~ ([0-9]+)x([0-9]+) ]]; then
                        IMG_WIDTH="${BASH_REMATCH[1]}"
                        IMG_HEIGHT="${BASH_REMATCH[2]}"
                        
                        # Account for rotation
                        EXPECTED_WIDTH=${{ matrix.resolution_width }}
                        EXPECTED_HEIGHT=${{ matrix.resolution_height }}
                        if [ "${{ matrix.rotation_degrees }}" = "90" ] || [ "${{ matrix.rotation_degrees }}" = "270" ]; then
                          # Swap expected dimensions for 90/270 degree rotations
                          EXPECTED_WIDTH=${{ matrix.resolution_height }}
                          EXPECTED_HEIGHT=${{ matrix.resolution_width }}
                        fi
                        
                        if [ "$IMG_WIDTH" = "$EXPECTED_WIDTH" ] && [ "$IMG_HEIGHT" = "$EXPECTED_HEIGHT" ]; then
                          echo "âœ… Screenshot $i dimensions correct: ${IMG_WIDTH}x${IMG_HEIGHT}"
                          VALIDATION_MESSAGES="${VALIDATION_MESSAGES}- Screenshot $i resolution: ${IMG_WIDTH}x${IMG_HEIGHT} âœ…\n"
                        else
                          echo "âŒ Screenshot $i dimensions incorrect: got ${IMG_WIDTH}x${IMG_HEIGHT}, expected ${EXPECTED_WIDTH}x${EXPECTED_HEIGHT}"
                          VALIDATION_MESSAGES="${VALIDATION_MESSAGES}- Screenshot $i resolution: ${IMG_WIDTH}x${IMG_HEIGHT} (expected ${EXPECTED_WIDTH}x${EXPECTED_HEIGHT}) âŒ\n"
                          TEST_PASSED=false
                        fi
                      fi
                      
                      # Check grayscale
                      if [ "${{ matrix.grayscale }}" = "true" ]; then
                        # Check if image is grayscale using multiple methods
                        COLOR_TYPE=$(identify -ping -format "%[colorspace]" "$SCREENSHOT_FILE" 2>/dev/null || echo "Unknown")
                        # Also check PNG color type from file command
                        PNG_TYPE=""
                        if [[ "$FILE_INFO" =~ grayscale ]]; then
                          PNG_TYPE="grayscale"
                        elif [[ "$FILE_INFO" =~ RGB ]]; then
                          PNG_TYPE="RGB"
                        fi
                        
                        # Check if it's actually grayscale by examining unique colors
                        UNIQUE_COLORS=$(identify -ping -format "%[colors]" "$SCREENSHOT_FILE" 2>/dev/null || echo "0")
                        
                        if [[ "$COLOR_TYPE" =~ Gray|Grayscale ]] || [[ "$PNG_TYPE" == "grayscale" ]]; then
                          echo "âœ… Screenshot $i is grayscale as expected (colorspace: $COLOR_TYPE, PNG type: $PNG_TYPE)"
                          VALIDATION_MESSAGES="${VALIDATION_MESSAGES}- Screenshot $i: Grayscale âœ…\n"
                        else
                          # Additional check: if it has very few colors, it might still be grayscale
                          if [ "$UNIQUE_COLORS" -le 256 ] && [ "${{ matrix.bit_depth }}" -le 8 ]; then
                            echo "âœ… Screenshot $i appears grayscale (colorspace: $COLOR_TYPE, colors: $UNIQUE_COLORS, PNG type: $PNG_TYPE)"
                            VALIDATION_MESSAGES="${VALIDATION_MESSAGES}- Screenshot $i: Likely grayscale ($UNIQUE_COLORS colors) âœ…\n"
                          else
                            echo "âŒ Screenshot $i colorspace: $COLOR_TYPE, PNG type: $PNG_TYPE (expected grayscale)"
                            VALIDATION_MESSAGES="${VALIDATION_MESSAGES}- Screenshot $i: $COLOR_TYPE/$PNG_TYPE (expected grayscale) âŒ\n"
                            TEST_PASSED=false
                          fi
                        fi
                      fi
                      
                      # Check bit depth using file command for more accurate PNG bit depth detection
                      BIT_DEPTH_IDENTIFY=$(identify -ping -format "%[depth]" "$SCREENSHOT_FILE" 2>/dev/null || echo "Unknown")
                      # Use file command to get actual PNG bit depth from file header
                      FILE_INFO=$(file "$SCREENSHOT_FILE" 2>/dev/null || echo "")
                      if [[ "$FILE_INFO" =~ ([0-9]+)-bit ]]; then
                        ACTUAL_BIT_DEPTH="${BASH_REMATCH[1]}"
                      else
                        ACTUAL_BIT_DEPTH="$BIT_DEPTH_IDENTIFY"
                      fi
                      
                      EXPECTED_DEPTH=${{ matrix.bit_depth }}
                      # Handle bit depth fallback for invalid values
                      if [ "$EXPECTED_DEPTH" = "99" ]; then
                        EXPECTED_DEPTH=8  # Should fallback to default
                      fi
                      
                      echo "Screenshot $i bit depth: $ACTUAL_BIT_DEPTH (identify reported: $BIT_DEPTH_IDENTIFY, expected: $EXPECTED_DEPTH)"
                      
                      # Validate bit depth
                      if [ "$ACTUAL_BIT_DEPTH" = "$EXPECTED_DEPTH" ]; then
                        echo "âœ… Screenshot $i bit depth correct: $ACTUAL_BIT_DEPTH"
                        VALIDATION_MESSAGES="${VALIDATION_MESSAGES}- Screenshot $i bit depth: $ACTUAL_BIT_DEPTH âœ…\n"
                      else
                        echo "âŒ Screenshot $i bit depth: $ACTUAL_BIT_DEPTH (expected: $EXPECTED_DEPTH)"
                        VALIDATION_MESSAGES="${VALIDATION_MESSAGES}- Screenshot $i bit depth: $ACTUAL_BIT_DEPTH (expected $EXPECTED_DEPTH) âŒ\n"
                        TEST_PASSED=false
                      fi
                    fi
                  fi
                done
              else
                echo "âŒ Wrong number of screenshots: got $ACTUAL_FILES, expected ${{ matrix.expected_files }}"
                VALIDATION_MESSAGES="${VALIDATION_MESSAGES}- Generated $ACTUAL_FILES screenshots (expected ${{ matrix.expected_files }}) âŒ\n"
                TEST_PASSED=false
              fi
            else
              # Expected failure case
              if [ "$ACTUAL_FILES" -eq 0 ] || [ "${{ steps.container_test.outputs.container_exit_code }}" != "0" ]; then
                echo "âœ… Test correctly failed as expected"
                VALIDATION_MESSAGES="${VALIDATION_MESSAGES}- Test failed as expected âœ…\n"
              else
                echo "âŒ Test should have failed but didn't"
                VALIDATION_MESSAGES="${VALIDATION_MESSAGES}- Test should have failed but generated $ACTUAL_FILES files âŒ\n"
                TEST_PASSED=false
              fi
            fi
          fi
          
          # Output results
          echo "test_passed=$TEST_PASSED" >> $GITHUB_OUTPUT
          echo -e "$VALIDATION_MESSAGES" > validation-messages-${{ matrix.name }}.txt
          
          # Print container logs for debugging
          echo "=== Container Output ==="
          cat container-output-${{ matrix.name }}.log || echo "No container output available"
          
          if [ "$TEST_PASSED" = "true" ]; then
            echo "ðŸŽ‰ Test ${{ matrix.name }} PASSED"
          else
            echo "ðŸ’¥ Test ${{ matrix.name }} FAILED"
            if [ "${{ matrix.expected_result }}" = "success" ]; then
              exit 1
            fi
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.name }}
          path: |
            test-share-${{ matrix.name }}/${{ env.SCREENSHOT_SUBFOLDER }}/
            container-output-${{ matrix.name }}.log
            validation-messages-${{ matrix.name }}.txt
          retention-days: 7

  # Summary job to collect all matrix results
  test-summary:
    if: ${{ always() && (github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && fromJson(github.event.inputs.run_all_tests || 'true'))) }}
    needs: matrix-test
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate test summary
        run: |
          echo "# ðŸ§ª HA Screenshotter Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Case | Description | Expected Result | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------------|----------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Note: This is a simplified summary. In a real implementation, 
          # we would need to collect the actual results from the matrix jobs.
          # For now, we'll show the test cases that were configured.
          
          echo "| basic-test | Single URL, no grayscale, full bit depth | Success | ${{ needs.matrix-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| multi-grayscale-medium | Two URLs, grayscale, medium bit depth | Success | ${{ needs.matrix-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY  
          echo "| multi-grayscale-minimal | Two URLs, grayscale, minimal bit depth | Success | ${{ needs.matrix-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| invalid-url | Non-existent URL test | Failure | ${{ needs.matrix-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| malformed-urls | Invalid JSON format for URLs | Failure | ${{ needs.matrix-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| invalid-bit-depth | Invalid bit depth value | Success (fallback) | ${{ needs.matrix-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Overall Result" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.matrix-test.result }}" = "success" ]; then
            echo "**âœ… All tests completed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "**âŒ Some tests failed. Check individual test results above.**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test artifacts are available for download with detailed validation results." >> $GITHUB_STEP_SUMMARY
